
```{r ddAMfitsToHist, echo = FALSE, warning = FALSE}

AMs <- c(1,2,4,7,11)

AMfitList <- vector(mode = "list", length = 5)

for( k in 1:5 )
{
  load(file.path("./data/AM",AMs[k],"/outList.Rdata"))
  AMfitList[[k]] <- outList
}


```

\newpage

# Tables

```{r ddEqbmTable, echo = FALSE, warning =  FALSE }
eqbmTab <- read.csv( "./data/eqbmTable.csv", header = T,
                      stringsAsFactors = FALSE ) 

eqbmTabCap <- "Unfished and fished equilibrium quantities for the delay-difference population dynamics."

csasdown::csas_table(  eqbmTab, caption = eqbmTabCap )

```

\newpage


```{r ddModelTable, echo = FALSE, warning =  FALSE }
ddModelTab <- read.csv( "./data/ddModelTab.csv", header = T,
                        stringsAsFactors = FALSE ) 

ddModelTabCap <- "Process and observation model components of the delay difference stock assessment model used in BC Sablefish management procedures. Initialisation values for biomass, numbers, and recruitment are equilibrium unfished values from Table 2."

csasdown::csas_table(   ddModelTab, 
                        caption = ddModelTabCap,
                        format = kable_format ) %>% 
            group_rows("Model Free Parameters", 1, 1, bold =T, italic = F ) %>%
            group_rows("Initialisation $(t = 1)$", 2, 4, bold =T, italic = F, escape = F ) %>%
            group_rows("Mixed Area Biomass", 5, 6, bold =T, italic = F, escape = F ) %>%
            group_rows("Stock Specific Catch", 7, 7, bold =T, italic = F, escape = F ) %>%
            group_rows("Time series Reconstruction $(2 \\\\leq t \\\\leq T)$", 8, 11, bold =T, italic = F, escape = F ) %>%
            group_rows("Statistical Model", 12, 15, bold =T, italic = F ) 

```

\newpage

```{r, echo=FALSE, include=FALSE}
hcrGrid <- tibble::tribble(
  ~UpperControlPoint,  ~MaxHarvestRate,   ~Caps,
    "$B_{MSY}$",         "$F_{MSY}$",     "$(MSY,MSY)$",
    "$.4B_0$",           "$\\frac{2}{3}M$","$hi = (4,25)$",
    NA,                   NA,             "$lo = (2.5,20)$"
)
names(hcrGrid) <- c("Upper Control Point", "Maximum harvest rate", "TAC Caps")

hcrGridCaption <- "Harvest control rule settings that we tested. A harvest control rule is defined by taking one element from each column." 
```

```{r, results='asis'}
csasdown::csas_table(hcrGrid, caption = hcrGridCaption)
```

\newpage

```{r ddAMHistFitTable, echo = FALSE, warning = FALSE}

ddAMFitTableCap <- "Delay difference assessment model estimates of unfished biomass, natural mortality, and biological reference points, when fit to the tuning grid of operating models 1, 2, 4, 7, and 11."

colNamesFitTable <- c(  "AM", 
                        "$B_{0,MED}$", 
                        "$B_{MSY,MED}$", 
                        "$F_{MSY,MED}$", 
                        "$MSY_{MED}$", 
                        "$M_{MED}$",
                        "$B_{0,GOM}$", 
                        "$B_{MSY,GOM}$", 
                        "$F_{MSY,GOM}$", 
                        "$MSY_{GOM}$", 
                        "$M_{GOM}$")

amFitTable <- matrix(NA, nrow = 5, ncol = length(colNamesFitTable))
colnames(amFitTable) <- colNamesFitTable
amFitTable <- as.data.frame(amFitTable)

for( k in 1:length(AMs) )
{
  amFitTable$AM[k] <- AMs[k]
  amFitTable[k,c("$B_{0,MED}$","$B_{0,GOM}$")] <- round(AMfitList[[k]]$mpOutput$B0_s,2)
  amFitTable[k,c("$B_{MSY,MED}$","$B_{MSY,GOM}$")] <- round(AMfitList[[k]]$mpOutput$Bmsy,2)
  amFitTable[k,c("$F_{MSY,MED}$","$F_{MSY,GOM}$")] <- round(AMfitList[[k]]$mpOutput$Fmsy,2)
  amFitTable[k,c("$MSY_{MED}$","$MSY_{GOM}$")] <- round(AMfitList[[k]]$mpOutput$msy,2)
  amFitTable[k,c("$M_{MED}$","$M_{GOM}$")] <- round(AMfitList[[k]]$repOpt$M_s,2)

}

csasdown::csas_table( amFitTable,
                      caption = ddAMFitTableCap,
                      format = kable_format,
                      landscape = TRUE ) %>%
          add_header_above( c(" " = 1, "Mediterranean Spawners" = 5, "Gulf of Mexico Spawners" = 5 ),
                    bold = T )

```

\newpage
# Figures
```{r sourcePlots, echo = FALSE, include = FALSE, warning = FALSE}
source("../MME_MP/plots.R")
source("../MME_MP/MPs.R")
```


```{r OMbioCaption, echo = FALSE, include = FALSE, warning = FALSE}
OMbioCap <- "Operating model spawning stock biomasses for the full reference grid for both the Mediterannean stock (East) and Gulf of Mexico stock (West). Each colour corresponds to a different OM from the reference grid."
```

```{r OMbioPlot, echo = FALSE, warning = FALSE, out.width = "90%", fig.align = "center", fig.cap=OMbioCap}
# Include the graphics
knitr::include_graphics("data/OMbiomass.pdf")

```

\newpage

```{r, echo = FALSE, include = FALSE, warning = FALSE}
hcrPlotCap <- "An example harvest control rule with maximum harvest rate $U_{max} =  0.08$, an upper control point of $B_{MSY} = 57$, and a TAC cap at 4 kt."
```

\blandscape

```{r, hcrPlot, echo = FALSE, warning = FALSE, out.width = "90%", fig.align = "center", fig.cap=hcrPlotCap}
plotHCR(  Ftarg = 0.08,
          cap = 4,
          LCP = .4,
          UCP = 1.0,
          Bmsy = 57 )
```
\elandscape

\newpage

```{r AMfitPlotsCaptions, echo = FALSE, include = FALSE, warning = FALSE}
amBiomassCap <- "Spawning stock biomass estimates by stock (left hand column) and area (right hand column) from the delay difference stock assessment model fit to OM 1. Total area catch is shown split into East stock (red bars) and West stock (blue bars). Note that the catch scale is exaggerated with respect to the biomass, so that West stock catch is visible in the East area."

amIdxFitsCap <- "Fits of the delay difference stock assessment model to stock and area management indices, with the associated catchability estimates. Data are shown as circles, while the lines indicate the model biomass scaled by catchability. East Stock and West Stock indices are the spawning stock biomass estimates from operating model 1."

amRefPtsCap <- "Equlibrium biomass (black) and yield (grey) curves as a function of fishing mortality estimated by the delay difference model fits to the management indices and operating model 1 spawning stock biomass."

```

```{r amBiomassPlot, echo = FALSE, warning = FALSE, out.width = "90%", fig.align = "center", fig.cap=amBiomassCap}
knitr::include_graphics("data/AM/1/biomass.pdf")
```

\newpage

```{r amIdxFitsPlot, echo = FALSE, warning = FALSE, out.width = "90%", fig.align = "center", fig.cap=amIdxFitsCap}
knitr::include_graphics("data/AM/1/indexFits.pdf")
```

\newpage

```{r amRefPtsPlot, echo = FALSE, warning = FALSE, out.width = "90%", fig.align = "center", fig.cap=amRefPtsCap}
knitr::include_graphics("data/AM/1/BRP.pdf")
```

\newpage

```{r, echo = FALSE, include = FALSE }
empFitCheckCaption <- "A single simulation replicate from Operating Model 1, showing estimated and simulated spawning stock biomass (coloured dots and red lines), and the area catch (black lines) with mean and central $90\\%$ of the distributions of multi-model TAC advice (black points and grey vertical segments in the catch projection period). Each colour of a dot corresponds to the estimate of biomass when using parameters from the tuning subset operating model indicated in the legend."

DDFitCheckCaption_OM1 <- "A single simulation replicate from Operating Model 1, showing estimated and simulated spawning stock biomass (coloured dots and red lines), and the area catch (black lines) under the MP\\_msyCapF23M.4B0 CMP. In the biomass panels, each colour of a dot corresponds to the estimate of biomass when using AMs tuned to the tuning subset OM indicated in the legend. In the catch panels, multi-model TAC advice is overlaid in the projection period with the mean (circular points), AIC weighted TAC (triangular points), and central $90\\%$ of the distributions of sub-procedure TAC (vertical segments) in the projection period."

DDFitCheckCaption_OM8 <- "A single simulation replicate from Operating Model 8, which is outside of the tuning subset, showing estimated and simulated spawning stock biomass (coloured dots and red lines), and the area catch (black lines) under the MP\\_aic\\_msyCapF23 CMP. In the biomass panels, each colour of a dot corresponds to the estimate of biomass when using AMs tuned to the tuning subset OM indicated in the legend. In the catch panels, multi-model TAC advice is overlaid in the projection period with the mean (circular points), AIC weighted TAC (triangular points), and central $90\\%$ of the distributions of sub-procedure TAC (vertical segments) in the projection period."
```


```{r, echo = FALSE, warning = FALSE, out.width = "90%", fig.align = "center", fig.cap=empFitCheckCaption}
knitr::include_graphics("data/fitCheck_sim3_OM_1_empMP_msyCap.pdf")
```

\newpage

```{r, echo = FALSE, include = FALSE, warning = FALSE}

empPerfCap_MSY <- "Distributions of MP performance metrics $B_{30}$ and $AvC_{30}$ for empirical MPs with TAC caps set at maximum sustainable yield. Points show the median value of the performance metric, and segments show the central 90\\% of the distribution over all simulation replicates."
empPerfCap_noCaps <- "Distributions of MP performance metrics $B_{30} = B_{2046}/B_{MSY}$ and $AvC_{30} = \\frac{\\sum_{t = 2016}^{2046} C_t }{30}$ for empirical MPs with no absolute TAC cap. Points show the median value of the performance metric, and segments show the central 90\\% of the distribution over all simulation replicates."


aicTACs_DDMP_caption <- "Distributions of MP performance metrics $B_{30} = B_{2046}/B_{MSY}$ and $AvC_{30} = \\frac{\\sum_{t = 2016}^{2046} C_t }{30}$ for Delay Difference MPs with TAC caps set at AM MSY estimates, and TACs weighted by AM AIC values, applied to deterministic operating models. Points show the median value of the performance metric, and segments show the central 90\\% of the distribution over all simulation replicates."
msyMPs_DDMP_caption <- "Distributions of MP performance metrics $B_{30} = B_{2046}/B_{MSY}$ and $AvC_{30} = \\frac{\\sum_{t = 2016}^{2046} C_t }{30}$ for Delay Difference MPs with TAC caps set at AM MSY estimates, and TACs weighted equally, applied to operating models 1 through 15. Points show the median value of the performance metric, and segments show the central 90\\% of the distribution over all simulation replicates."


```

\blandscape
```{r, echo = FALSE, warning = FALSE, out.width = "90%", fig.align = "center", fig.cap = empPerfCap_MSY }
# Figure out how to make landscape
plotMSEperf(  OMvec = paste("OM_",1:15,sep = ""),
              projFolder = "../MME_MP/MSEs/msyCaps", 
              prefix = "test",
              ptcex = 1, segwd = 1 )

```

\elandscape

\newpage



```{r, echo = FALSE, warning = FALSE, out.width = "90%", fig.align = "center", fig.cap=DDFitCheckCaption_OM1}
knitr::include_graphics("data/fitCheck_sim5_OM_1_MP_msyCapF23M_4B0.png")
```

\newpage

\blandscape

```{r, echo = FALSE, warning = FALSE, out.width = "90%", fig.align = "center", fig.cap = aicTACs_DDMP_caption }
# Figure out how to make landscape
plotMSEperf(  OMvec = paste("OM_",1:15,"d",sep = ""),
              projFolder = "../testDDMP/MSEs/aicTACs_d", 
              prefix = "",
              ptcex = 1, segwd = 1 )

```

\newpage

```{r, echo = FALSE, warning = FALSE, out.width = "90%", fig.align = "center", fig.cap = msyMPs_DDMP_caption }
# Figure out how to make landscape
plotMSEperf(  OMvec = paste("OM_",1:15,sep = ""),
              projFolder = "../testDDMP/MSEs/msyMPs", 
              prefix = "",
              ptcex = 1, segwd = 1 )

```
\elandscape

\newpage



```{r, echo = FALSE, warning = FALSE, out.width = "90%", fig.align = "center", fig.cap=DDFitCheckCaption_OM8}
knitr::include_graphics("data/fitCheck_sim2_OM_8d_MP_aic_msyCapF23M.png")
```



